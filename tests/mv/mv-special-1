#! /bin/sh

: ${LS=ls}
: ${MV=mv}
: ${MKDIR=mkdir}
: ${MKNOD=mknod}
: ${RM=rm}
: ${TOUCH=touch}

. $srcdir/setup

if test -z "$other_partition_tmpdir"; then
  exit 77
fi

null=.mv-null
dir=.mv-dir

framework_failure=0

$RM -f $null || framework_failure=1
$MKNOD $null p || framework_failure=1
$MKDIR -p $dir/a/b/c $dir/d/e/f || framework_failure=1
$TOUCH $dir/a/b/c/file1 $dir/d/e/f/file2 || framework_failure=1

if test $framework_failure = 1; then
  echo 'failure in testing framework'
  exit 1
fi

# Make sure we get English translations.
LANGUAGE=C
export LANGUAGE
LC_ALL=C
export LC_ALL
LANG=C
export LANG

fail=0
$MV --verbose $null $dir $other_partition_tmpdir > out || fail=1
# Make sure the files are gone.
test -f $null && fail=1
test -d $dir && fail=1
# Make sure they were moved.
# Since `test -e' is not portable, use `ls'.
$LS $other_partition_tmpdir/$null > /dev/null || fail=1
test -d $other_partition_tmpdir/$dir/a/b/c || fail=1

sed "s,$other_partition_tmpdir,XXX," out > out2

cat > exp <<\EOF
.mv-null -> XXX/.mv-null
removing .mv-null
.mv-dir -> XXX/.mv-dir
.mv-dir/a -> XXX/.mv-dir/a
.mv-dir/a/b -> XXX/.mv-dir/a/b
.mv-dir/a/b/c -> XXX/.mv-dir/a/b/c
.mv-dir/a/b/c/file1 -> XXX/.mv-dir/a/b/c/file1
.mv-dir/d -> XXX/.mv-dir/d
.mv-dir/d/e -> XXX/.mv-dir/d/e
.mv-dir/d/e/f -> XXX/.mv-dir/d/e/f
.mv-dir/d/e/f/file2 -> XXX/.mv-dir/d/e/f/file2
removing all entries of directory .mv-dir
removing all entries of directory .mv-dir/a
removing all entries of directory .mv-dir/a/b
removing all entries of directory .mv-dir/a/b/c
removing .mv-dir/a/b/c/file1
removing the directory itself: .mv-dir/a/b/c
removing the directory itself: .mv-dir/a/b
removing the directory itself: .mv-dir/a
removing all entries of directory .mv-dir/d
removing all entries of directory .mv-dir/d/e
removing all entries of directory .mv-dir/d/e/f
removing .mv-dir/d/e/f/file2
removing the directory itself: .mv-dir/d/e/f
removing the directory itself: .mv-dir/d/e
removing the directory itself: .mv-dir/d
removing the directory itself: .mv-dir
EOF

cmp out2 exp || fail=1

# cd $other_partition_tmpdir
# $LS -l -A -R $other_partition_tmpdir

$RM -rf $null $dir $other_partition_tmpdir out out2 exp

exit $fail
